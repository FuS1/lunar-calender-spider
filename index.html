<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…«å­—å‘½ç†æŸ¥è©¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .element-wood { color: #16a34a; } /* Green */
        .element-fire { color: #dc2626; } /* Red */
        .element-earth { color: #d97706; } /* Brown context orange */
        .element-metal { color: #4b5563; } /* Gray */
        .element-water { color: #2563eb; } /* Blue */
        
        .bg-wood { background-color: #dcfce7; color: #14532d; }
        .bg-fire { background-color: #fee2e2; color: #7f1d1d; }
        .bg-earth { background-color: #fef3c7; color: #78350f; }
        .bg-metal { background-color: #f3f4f6; color: #1f2937; }
        .bg-water { background-color: #dbeafe; color: #1e3a8a; }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen py-10 px-4">

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- æŸ¥è©¢è¡¨å–®å€å¡Š -->
        <div class="bg-white p-8 rounded-2xl shadow-xl">
            <h1 class="text-3xl font-bold text-center text-slate-800 mb-8">å…«å­—å‘½ç›¤æŸ¥è©¢</h1>
            
            <form id="baziForm" class="flex flex-col md:flex-row gap-4 justify-center items-end">
                <div class="w-full md:w-auto">
                    <label for="birthDate" class="block text-sm font-semibold text-slate-600 mb-2">å‡ºç”Ÿæ—¥æœŸ</label>
                    <input type="date" id="birthDate" name="birthDate" required
                        class="w-full md:w-48 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                </div>

                <div class="w-full md:w-auto">
                    <label for="birthTime" class="block text-sm font-semibold text-slate-600 mb-2">å‡ºç”Ÿæ™‚è¾°</label>
                    <div class="relative">
                        <select id="birthTime" name="birthTime" required
                            class="w-full md:w-56 px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg appearance-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition pr-10">
                            <option value="" disabled selected>è«‹é¸æ“‡æ™‚è¾°</option>
                            <option value="23-01">å­æ™‚ (23:00 - 01:00)</option>
                            <option value="01-03">ä¸‘æ™‚ (01:00 - 03:00)</option>
                            <option value="03-05">å¯…æ™‚ (03:00 - 05:00)</option>
                            <option value="05-07">å¯æ™‚ (05:00 - 07:00)</option>
                            <option value="07-09">è¾°æ™‚ (07:00 - 09:00)</option>
                            <option value="09-11">å·³æ™‚ (09:00 - 11:00)</option>
                            <option value="11-13">åˆæ™‚ (11:00 - 13:00)</option>
                            <option value="13-15">æœªæ™‚ (13:00 - 15:00)</option>
                            <option value="15-17">ç”³æ™‚ (15:00 - 17:00)</option>
                            <option value="17-19">é…‰æ™‚ (17:00 - 19:00)</option>
                            <option value="19-21">æˆŒæ™‚ (19:00 - 21:00)</option>
                            <option value="21-23">äº¥æ™‚ (21:00 - 23:00)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                        </div>
                    </div>
                </div>

                <div class="w-full md:w-auto">
                    <button type="submit" 
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-6 rounded-lg transition duration-200 shadow-lg transform active:scale-95">
                        ç«‹å³æ’ç›¤
                    </button>
                </div>
            </form>
        </div>

        <!-- çµæœé¡¯ç¤ºå€ -->
        <div id="resultArea" class="hidden space-y-6">
            
            <!-- 1. åŸºæœ¬è³‡æ–™å¡ç‰‡ -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-indigo-900 px-6 py-4">
                    <h2 class="text-xl text-white font-bold flex items-center">
                        <span class="text-indigo-200 mr-2">ğŸ“Œ</span> å‘½ç›¤åŸºæœ¬è³‡æ–™
                    </h2>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 text-sm">
                    <div>
                        <span class="text-slate-400 block text-xs uppercase tracking-wider mb-1">è¾²æ›†æ—¥æœŸ</span>
                        <span id="lunarDateDisplay" class="font-medium text-slate-800 text-lg"></span>
                    </div>
                    <div>
                        <span class="text-slate-400 block text-xs uppercase tracking-wider mb-1">ç”Ÿè‚–</span>
                        <span id="zodiacDisplay" class="font-medium text-slate-800 text-lg"></span>
                    </div>
                    <div>
                        <span class="text-slate-400 block text-xs uppercase tracking-wider mb-1">å‘½ä¸»</span>
                        <span id="mingTypeDisplay" class="font-medium text-indigo-600 text-lg"></span>
                    </div>
                </div>
            </div>

            <!-- 2. å…«å­—å››æŸ± (æ ¸å¿ƒ) -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-6 border-l-4 border-indigo-500 pl-3">å…«å­—å‘½é€ </h3>
                <div class="grid grid-cols-4 gap-4 text-center">
                    <!-- æ¨™é ­ -->
                    <div class="text-slate-500 font-medium pb-2 border-b">å¹´æŸ±</div>
                    <div class="text-slate-500 font-medium pb-2 border-b">æœˆæŸ±</div>
                    <div class="text-slate-500 font-medium pb-2 border-b text-indigo-600">æ—¥æŸ±</div>
                    <div class="text-slate-500 font-medium pb-2 border-b">æ™‚æŸ±</div>

                    <!-- å¤©å¹² -->
                    <div id="yearGanBox" class="py-2"></div>
                    <div id="monthGanBox" class="py-2"></div>
                    <div id="dayGanBox" class="py-2"></div>
                    <div id="timeGanBox" class="py-2"></div>

                    <!-- åœ°æ”¯ -->
                    <div id="yearZhiBox" class="py-2"></div>
                    <div id="monthZhiBox" class="py-2"></div>
                    <div id="dayZhiBox" class="py-2"></div>
                    <div id="timeZhiBox" class="py-2"></div>
                </div>
            </div>

            <!-- 3. äº”è¡Œèˆ‡æ ¼å±€åˆ†æ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- äº”è¡Œåˆ†æ -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-green-500 pl-3">äº”è¡Œåˆ†æ</h3>
                    <div id="wuxingBar" class="space-y-3 mb-4">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <p id="wuxingSummary" class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg leading-relaxed"></p>
                </div>

                <!-- æ ¼å±€èˆ‡å‘½æ ¼ -->
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-orange-500 pl-3">å‘½æ ¼åˆ†æ</h3>
                    <div class="mb-4">
                        <span id="mingGeType" class="text-xl font-bold text-slate-800 ml-2"></span>
                    </div>
                    <p id="mingGeDesc" class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg leading-relaxed mb-4"></p>
                    <div id="mingGeStrength" class="text-sm border-t pt-2 mt-2"></div>
                </div>
            </div>

            <!-- åç¥åˆ†æ -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-amber-500 pl-3">åç¥åˆ†æ</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>
                                <th scope="col" class="px-4 py-3">æŸ±ä½</th>
                                <th scope="col" class="px-4 py-3">åç¥</th>
                                <th scope="col" class="px-4 py-3 min-w-[200px]">å«æ„</th>
                                <th scope="col" class="px-4 py-3 text-center">é¡å‹</th>
                            </tr>
                        </thead>
                        <tbody id="shiShenTableBody" class="divide-y divide-slate-100">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <p id="shiShenSummary" class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg leading-relaxed mt-4"></p>
            </div>

            <!-- ç¥ç…åˆ†æ -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-purple-500 pl-3">ç¥ç…åˆ†æ</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>
                                <th scope="col" class="px-4 py-3">ç¥ç…åç¨±</th>
                                <th scope="col" class="px-4 py-3 text-center">é¡å‹</th>
                                <th scope="col" class="px-4 py-3">æ‰€åœ¨æŸ±ä½</th>
                                <th scope="col" class="px-4 py-3 min-w-[200px]">å«æ„</th>
                            </tr>
                        </thead>
                        <tbody id="shenShaTableBody" class="divide-y divide-slate-100">
                            <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
                <p id="shenShaSummary" class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg leading-relaxed mt-4"></p>
            </div>

            <!-- 5. å¤§é‹ -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-blue-500 pl-3">å¤§é‹æ’ç›¤</h3>
                <div id="dayunInfo" class="mb-4 text-sm text-slate-500"></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full border-collapse text-center text-sm" id="dayunTable">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </table>
                </div>
            </div>

            <!-- 6. å‘½ç›¤é—œä¿‚ (åˆ‘è¡æœƒåˆ) -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-pink-500 pl-3">å‘½ç›¤é—œä¿‚ (åˆ‘è¡æœƒåˆ)</h3>
                
                <div class="space-y-4">
                    <div>
                        <h4 class="text-sm font-bold text-slate-600 mb-2">å¤©å¹²åœ°æ”¯é—œä¿‚</h4>
                        <div id="pairwiseRelations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-slate-600 mb-2">åˆå±€èˆ‡æ–¹å±€</h4>
                        <div id="groupRelations" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"></div>
                    </div>
                </div>
            </div>

            <!-- 7. æµå¹´é‹å‹¢ -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-yellow-500 pl-3">æµå¹´é‹å‹¢</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full border-collapse text-center text-sm" id="liuNianTable">
                        <!-- JS å‹•æ…‹ç”Ÿæˆ -->
                    </table>
                </div>
                <div class="mt-4 p-3 bg-red-50 rounded border border-red-100 text-sm text-slate-600">
                    <span class="font-bold text-red-600 mr-2">âš ï¸ ç‰¹åˆ¥æ³¨æ„ï¼š</span>
                    è¡¨æ ¼ä¸­æ¨™ç¤ºç‚ºç´…è‰²èƒŒæ™¯çš„å¹´ä»½ï¼ˆä¸ƒæ€ã€å‚·å®˜ï¼‰ï¼Œä»£è¡¨è©²å¹´è®Šå‹•è¼ƒå¤§æˆ–å£“åŠ›è¼ƒå¼·ï¼Œè¡Œäº‹å®œè¬¹æ…ä¿å®ˆï¼Œæ³¨æ„èº«é«”å¥åº·èˆ‡äººéš›é—œä¿‚ã€‚
                </div>
            </div>

            <!-- 8. æµæœˆé‹å‹¢ -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold text-slate-800 mb-4 border-l-4 border-cyan-500 pl-3">è¿‘æœŸæµæœˆé‹å‹¢</h3>
                <div id="liuYueList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- JS å‹•æ…‹ç”Ÿæˆæµæœˆåˆ—è¡¨ -->
                </div>
            </div>
            
            <!-- åŸå§‹è³‡æ–™ (Hidden default, toggleable) -->
            <div class="text-center">
                <button onclick="$('#rawJson').toggle()" class="text-indigo-400 text-sm hover:underline">æŸ¥çœ‹åŸå§‹ JSON è³‡æ–™</button>
            </div>
            <pre id="rawJson" class="hidden mt-4 p-4 bg-slate-800 text-green-400 rounded-xl text-xs overflow-x-auto text-left"></pre>

        </div>
    </div>

    <script>
        $(document).ready(function() {
            // å…ƒç´ å°æ‡‰é¡è‰² helper
            const getElementClass = (text) => {
                if(text.includes('æœ¨')) return 'element-wood';
                if(text.includes('ç«')) return 'element-fire';
                if(text.includes('åœŸ')) return 'element-earth';
                if(text.includes('é‡‘')) return 'element-metal';
                if(text.includes('æ°´')) return 'element-water';
                return 'text-slate-800';
            };
            
            const getBGClass = (text) => {
                if(text.includes('æœ¨')) return 'bg-wood';
                if(text.includes('ç«')) return 'bg-fire';
                if(text.includes('åœŸ')) return 'bg-earth';
                if(text.includes('é‡‘')) return 'bg-metal';
                if(text.includes('æ°´')) return 'bg-water';
                return 'bg-slate-100';
            };

            const parseIfString = (data) => {
                if (typeof data === 'string') {
                    try { return JSON.parse(data); } catch(e) { return null; }
                }
                return data;
            };

            $('#baziForm').on('submit', function(e) {
                e.preventDefault();

                const date = $('#birthDate').val();
                const timeRange = $('#birthTime').val();
                const $btn = $(this).find('button');
                const originalText = $btn.text();
                
                $btn.prop('disabled', true).text('å‘½ç›¤è¨ˆç®—ä¸­...');

                $.ajax({
                    url: 'http://localhost:3000/api/calculate',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        birthDate: date,
                        birthTimeRange: timeRange
                    }),
                    success: function(response) {
                        $('#resultArea').removeClass('hidden');

                        if(!response.data) {
                            alert(response.message || 'æŸ¥ç„¡è³‡æ–™');
                            return;
                        }

                        const d = response.data;
                        const wuXing = parseIfString(d.wuXing);
                        const mingGe = parseIfString(d.mingGe);
                        const wuXingAnalysis = parseIfString(d.wuXingAnalysis);
                        const shiShenAnalysis = parseIfString(d.shiShenAnalysis);
                        const shenSha = parseIfString(d.shenShaAnalysis);
                        const daYun = parseIfString(d.daYunWithStarting);

                        // 1. åŸºæœ¬è³‡æ–™
                        $('#solarDateDisplay').text(d.solarDate);
                        $('#lunarDateDisplay').text(d.lunarDate);
                        $('#zodiacDisplay').text(d.zodiacSign);
                        $('#mingTypeDisplay').text(d.mingType);

                        // 2. å››æŸ±
                        // è§£æå„æŸ±çš„å¤©å¹²åœ°æ”¯
                        const setPillar = (type, pillarText, wxInfo) => {
                            if (!pillarText) return;
                            const gan = pillarText[0];
                            const zhi = pillarText[1];
                            const ganEle = wxInfo?.tianGan || '';
                            const zhiEle = wxInfo?.diZhi || '';

                            $(`#${type}GanBox`).html(`
                                <div class="text-3xl font-serif ${getElementClass(ganEle)}">${gan}</div>
                                <div class="text-xs text-slate-500 mt-1 font-medium bg-slate-100 rounded px-1 inline-block" title="å¤©å¹²äº”è¡Œï¼š${ganEle}">${ganEle}</div>
                            `);
                            
                            $(`#${type}ZhiBox`).html(`
                                <div class="text-3xl font-serif ${getElementClass(zhiEle)}">${zhi}</div>
                                <div class="text-xs text-slate-500 mt-1 font-medium bg-slate-100 rounded px-1 inline-block" title="åœ°æ”¯äº”è¡Œï¼š${zhiEle}">${zhiEle}</div>
                            `);
                        };

                        setPillar('year', d.yearPillar, wuXing?.year);
                        setPillar('month', d.monthPillar, wuXing?.month);
                        setPillar('day', d.dayPillar, wuXing?.day);
                        setPillar('time', d.timePillar, wuXing?.time);

                        // 3. äº”è¡Œåˆ†æ
                        if (wuXingAnalysis) {
                            const counts = wuXingAnalysis.counts;
                            let barHtml = '';
                            const total = Object.values(counts).reduce((a,b)=>a+b, 0);
                            
                            ['é‡‘', 'æœ¨', 'æ°´', 'ç«', 'åœŸ'].forEach(ele => {
                                const count = counts[ele] || 0;
                                const pct = total > 0 ? (count / total) * 100 : 0;
                                
                                barHtml += `
                                    <div class="flex items-center">
                                        <div class="w-10 text-sm font-bold ${getElementClass(ele)}">${ele}</div>
                                        <div class="w-8 text-xs text-slate-500 text-right pr-2">${count}</div>
                                        <div class="flex-1 bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                            <div class="h-2.5 rounded-full ${getBGClass(ele).replace('color', 'bg').split(' ')[0]}" style="width: ${pct}%"></div>
                                        </div>
                                    </div>
                                `;
                            });
                            $('#wuxingBar').html(barHtml);
                            // ç§»é™¤æ›è¡Œç¬¦è™Ÿæ•´ç†æ–‡å­—
                            $('#wuxingSummary').html((wuXingAnalysis.analysis || '').replace(/\n/g, '<br>'));
                        }

                        // æ ¼å±€
                        if (mingGe) {
                            $('#mingGeType').text(mingGe.type);
                            $('#mingGeDesc').text(mingGe.description);
                            $('#mingGeStrength').html((mingGe.strength?.explanation || '').replace(/\n/g, '<br>'));
                        }

                        // åç¥åˆ†æ
                        if (shiShenAnalysis) {
                            let rows = '';
                            (shiShenAnalysis.relations || []).forEach(rel => {
                                const isHidden = rel.isHidden ? '<span class="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">è—å¹²</span>' : '<span class="text-xs text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded font-bold">æœ¬æ°£</span>';
                                const shiShenColor = ['ä¸ƒæ€', 'å‚·å®˜', 'åå°', 'åŠ«è²¡'].some(x => rel.shiShen.includes(x)) ? 'text-red-600' : 'text-emerald-700';
                                
                                rows += `
                                    <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                                        <td class="px-4 py-3 font-medium text-slate-700">${rel.pillar}</td>
                                        <td class="px-4 py-3 font-bold ${shiShenColor}">${rel.shiShen}</td>
                                        <td class="px-4 py-3 text-xs text-slate-600 leading-relaxed">${rel.description || ''}</td>
                                        <td class="px-4 py-3 text-center">${isHidden}</td>
                                    </tr>
                                `;
                            });
                            $('#shiShenTableBody').html(rows);
                            $('#shiShenSummary').html((shiShenAnalysis.analysis || '').replace(/\n/g, '<br>'));
                        }

                        // 4. ç¥ç…
                        if (shenSha) {
                            let rows = '';
                            const allSha = [
                                ...(shenSha.jiShen || []).map(s => ({...s, isJi: true})), 
                                ...(shenSha.xiongSha || []).map(s => ({...s, isJi: false}))
                            ];
                            
                            allSha.forEach(item => {
                                const typeBadge = item.isJi 
                                    ? '<span class="px-2 py-0.5 rounded text-xs font-bold bg-green-100 text-green-700">å‰ç¥</span>'
                                    : '<span class="px-2 py-0.5 rounded text-xs font-bold bg-red-100 text-red-700">å‡¶ç…</span>';
                                
                                rows += `
                                    <tr class="hover:bg-slate-50 transition border-b border-slate-50 last:border-0">
                                        <td class="px-4 py-3 font-bold text-slate-700">${item.name}</td>
                                        <td class="px-4 py-3 text-center">${typeBadge}</td>
                                        <td class="px-4 py-3 text-slate-600">${item.location}</td>
                                        <td class="px-4 py-3 text-xs text-slate-500 leading-relaxed">${item.description}</td>
                                    </tr>
                                `;
                            });
                            
                            if(allSha.length === 0) {
                                rows = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">ç„¡ç‰¹æ®Šç¥ç…</td></tr>';
                            }

                            $('#shenShaTableBody').html(rows);
                            $('#shenShaSummary').html((shenSha.analysis || '').replace(/\n/g, '<br>'));
                        }

                        // 5. å¤§é‹
                        if (daYun) {
                            $('#dayunInfo').text(`${daYun.startingAge?.age} (${daYun.startingAge?.startDate})`);
                            
                            const pillars = daYun.daYun || [];
                            
                            let rowShiShen = '<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600">ä¸»æ˜Ÿ</td>';
                            let rowGan = '<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600">å¤©å¹²</td>';
                            let rowZhi = '<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600">åœ°æ”¯</td>';
                            let rowAge = '<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600">è™›æ­²</td>';
                            let rowYear = '<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600">èµ·é‹</td>';

                            pillars.forEach(dy => {
                                const gan = dy.ganZhi[0];
                                const zhi = dy.ganZhi[1];
                                const wuxingGan = dy.wuXing?.tianGan || '';
                                const wuxingZhi = dy.wuXing?.diZhi || '';
                                
                                rowShiShen += `<td class="p-2 border border-slate-100 min-w-[60px] text-xs font-medium text-slate-600">${dy.shiShen}</td>`;
                                rowGan += `<td class="p-2 border border-slate-100 text-xl font-serif ${getElementClass(wuxingGan)}">${gan}</td>`;
                                rowZhi += `<td class="p-2 border border-slate-100 text-xl font-serif ${getElementClass(wuxingZhi)}">${zhi}</td>`;
                                rowAge += `<td class="p-2 border border-slate-100 text-xs text-slate-500">${dy.startYear}</td>`;
                                rowYear += `<td class="p-2 border border-slate-100 text-xs text-slate-500">${dayjs(dy.startDate).year()}</td>`;
                            });

                            rowShiShen += '</tr>';
                            rowGan += '</tr>';
                            rowZhi += '</tr>';
                            rowAge += '</tr>';
                            rowYear += '</tr>';

                            $('#dayunTable').html(rowShiShen + rowGan + rowZhi + rowAge + rowYear);
                        }

                        // 6. å‘½ç›¤é—œä¿‚
                        const relations = parseIfString(d.relations);
                        if(relations) {
                            // Pairwise
                            const pairHtml = (relations.pairwise || []).map(r => `
                                <div class="bg-slate-50 p-2 rounded border border-slate-200 text-sm">
                                    <span class="font-bold text-slate-700">${r.label}</span>
                                    <span class="bg-slate-200 text-xs px-1 rounded ml-1 text-slate-600">${r.category}</span>
                                </div>
                            `).join('') || '<div class="text-sm text-slate-400">ç„¡æ˜é¡¯è¡åˆ</div>';
                            $('#pairwiseRelations').html(pairHtml);

                            // Groups
                            const groupHtml = (relations.groups || []).map(g => `
                                <div class="bg-indigo-50 p-2 rounded border border-indigo-100 text-sm">
                                    <span class="font-bold text-indigo-700">${g.label}</span>
                                    <span class="text-xs text-indigo-500 ml-1">(${g.elements.join(',')})</span>
                                </div>
                            `).join('') || '<div class="text-sm text-slate-400">ç„¡åˆå±€</div>';
                            $('#groupRelations').html(groupHtml);
                        }

                        // 7. æµå¹´é‹å‹¢
                        const liuNian = parseIfString(d.liuNian);
                        if(liuNian && Array.isArray(liuNian)) {
                            // é¡¯ç¤ºæ‰€æœ‰æµå¹´è³‡æ–™
                            const list = liuNian;
                            
                            // ç¬¬ä¸€åˆ—å›ºå®šé¡¯ç¤º (Sticky Column)
                            const stickyClass = "sticky left-0 z-10 shadow-sm border-r border-slate-200";

                            let rowShiShen = `<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600 ${stickyClass}">ä¸»æ˜Ÿ</td>`;
                            let rowGan = `<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600 ${stickyClass}">å¤©å¹²</td>`;
                            let rowZhi = `<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600 ${stickyClass}">åœ°æ”¯</td>`;
                            let rowAge = `<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600 ${stickyClass}">è™›æ­²</td>`;
                            let rowYear = `<tr><td class="p-3 border border-slate-100 bg-slate-50 font-bold whitespace-nowrap text-slate-600 ${stickyClass}">å¹´ä»½</td>`;

                            list.forEach(ln => {
                                const gan = ln.ganZhi[0];
                                const zhi = ln.ganZhi[1];
                                const wuxingGan = ln.wuXing?.tianGan || '';
                                const wuxingZhi = ln.wuXing?.diZhi || '';
                                
                                // æ¨™è¨˜å…‡æ˜Ÿ (ä¸ƒæ€ã€å‚·å®˜)
                                const isMajorXiong = ['ä¸ƒæ€', 'ä¸ƒæ®º', 'å‚·å®˜', 'ä¼¤å®˜'].some(x => ln.shiShen.includes(x));
                                const isXiong = ['ä¸ƒæ€', 'ä¸ƒæ®º', 'å‚·å®˜', 'ä¼¤å®˜', 'åå°', 'åŠ«è²¡', 'åŠ«è´¢'].some(x => ln.shiShen.includes(x));
                                
                                const cellClass = isMajorXiong ? 'bg-red-50 border-red-100' : 'border-slate-100';
                                const shiShenColor = isXiong ? 'text-red-600 font-bold' : 'text-slate-600';
                                const xiongMarker = isMajorXiong ? '<div class="text-[10px] text-red-500 mt-1 transform scale-90">âš ï¸æ³¨æ„</div>' : '';

                                rowShiShen += `<td class="p-2 border ${cellClass} min-w-[60px] text-xs font-medium ${shiShenColor}">${ln.shiShen}${xiongMarker}</td>`;
                                rowGan += `<td class="p-2 border ${cellClass} text-xl font-serif ${getElementClass(wuxingGan)}">${gan}</td>`;
                                rowZhi += `<td class="p-2 border ${cellClass} text-xl font-serif ${getElementClass(wuxingZhi)}">${zhi}</td>`;
                                rowAge += `<td class="p-2 border ${cellClass} text-xs text-slate-500">${ln.age}æ­²</td>`;
                                rowYear += `<td class="p-2 border ${cellClass} text-xs text-slate-500">${ln.year}</td>`;
                            });

                            rowShiShen += '</tr>';
                            rowGan += '</tr>';
                            rowZhi += '</tr>';
                            rowAge += '</tr>';
                            rowYear += '</tr>';

                            $('#liuNianTable').html(rowShiShen + rowGan + rowZhi + rowAge + rowYear);
                        }

                        // 8. æµæœˆé‹å‹¢
                        const liuYue = parseIfString(d.liuYue);
                        if(liuYue && Array.isArray(liuYue)) {
                            let lyHtml = '';
                            // é¡¯ç¤ºæ‰€æœ‰æµæœˆ
                            liuYue.forEach(ly => {
                                lyHtml += `
                                    <div class="bg-white border border-slate-200 p-4 rounded-lg shadow-sm">
                                        <div class="flex justify-between items-start mb-2">
                                            <div>
                                                <span class="text-sm font-bold text-slate-500 block">${ly.year}å¹´${ly.month}æœˆ</span>
                                                <span class="text-xl font-serif font-bold text-slate-800">${ly.ganZhi}</span>
                                            </div>
                                            <span class="text-xs px-2 py-1 rounded bg-slate-100 text-slate-600">${ly.shiShen}</span>
                                        </div>
                                        <div class="text-xs text-slate-500 mb-2">
                                            <span class="bg-indigo-50 text-indigo-700 px-1 rounded mr-1">${ly.jieQi?.name}</span>
                                            ${ly.jieQi?.start?.solar} ~ ${ly.jieQi?.end?.solar}
                                        </div>
                                        <p class="text-sm text-slate-600 leading-relaxed border-t border-slate-100 pt-2 mt-2">
                                            ${ly.analysis || 'å¹³é †ä¹‹æœˆ'}
                                        </p>
                                    </div>
                                `;
                            });
                            $('#liuYueList').html(lyHtml);
                        }

                        // åŸå§‹è³‡æ–™
                        $('#rawJson').text(JSON.stringify(d, null, 2));
                    },
                    error: function(xhr) {
                        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + (xhr.responseJSON?.error || 'é€£ç·šå¤±æ•—'));
                    },
                    complete: function() {
                        $btn.prop('disabled', false).text(originalText);
                    }
                });
            });
        });

        // å¼•å…¥ Day.js
    </script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
</body>
</html>